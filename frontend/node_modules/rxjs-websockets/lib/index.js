"use strict";
var Observable_1 = require("rxjs/Observable");
var BehaviorSubject_1 = require("rxjs/BehaviorSubject");
var defaultWebsocketFactory = function (url) { return new WebSocket(url); };
function connect(url, input, websocketFactory, jsonParse) {
    if (websocketFactory === void 0) { websocketFactory = defaultWebsocketFactory; }
    if (jsonParse === void 0) { jsonParse = true; }
    var connectionStatus = new BehaviorSubject_1.BehaviorSubject(0);
    var messages = new Observable_1.Observable(function (observer) {
        var socket = websocketFactory(url);
        var inputSubscription;
        var open = false;
        var closed = function () {
            if (!open)
                return;
            connectionStatus.next(connectionStatus.getValue() - 1);
            open = false;
        };
        socket.onopen = function () {
            open = true;
            connectionStatus.next(connectionStatus.getValue() + 1);
            inputSubscription = input.subscribe(function (data) {
                var sendData = jsonParse ? JSON.stringify(data) : data;
                socket.send(sendData);
            });
        };
        socket.onmessage = function (message) {
            var nextData = jsonParse ? JSON.parse(message.data) : message.data;
            observer.next(nextData);
        };
        socket.onerror = function (error) {
            closed();
            observer.error(error);
        };
        socket.onclose = function (event) {
            closed();
            if (event.wasClean)
                observer.complete();
            else
                observer.error(new Error(event.reason));
        };
        return function () {
            if (inputSubscription)
                inputSubscription.unsubscribe();
            if (socket) {
                closed();
                socket.close();
            }
        };
    });
    return { messages: messages, connectionStatus: connectionStatus };
}
Object.defineProperty(exports, "__esModule", { value: true });
exports.default = connect;
//# sourceMappingURL=index.js.map